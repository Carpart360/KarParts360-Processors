<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XCart Specifications Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .status { margin: 10px 0; padding: 8px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info-box { 
            margin: 15px 0; 
            padding: 10px; 
            border: 1px solid #b8daff; 
            background-color: #cce5ff; 
            color: #004085; 
            border-radius: 4px;
        }
        .sku-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 5px;
            padding: 5px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
        }
        .entry-count {
            font-weight: bold;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h2>XCart Specifications Generator</h2>
    <label>Upload Product Specifications File:</label>
    <input type="file" id="uploadSpecs" accept=".xlsx, .xls, .csv"><br><br>
    
    <label>Upload SKU File:</label>
    <input type="file" id="uploadSKU" accept=".xlsx, .xls, .csv"><br><br>
    
    <label>Enter Inventory Number:</label>
    <input type="text" id="searchInventory"><br><br>
    
    <button onclick="searchInventoryNumber()">Process</button>
    <button onclick="addToEntry()">Add to Entry</button>
    <button onclick="generateFullResult()">Generate Full Result</button>
    <button onclick="copyToClipboard()">Copy to Clipboard</button>
    <button onclick="clearEntries()">Clear Entries</button>
    
    <div id="statusMessage" class="status" style="display: none;"></div>
    
    <!-- SKU Information Box -->
    <div id="skuInfoBox" class="info-box" style="display: none;">
        <div id="skuCount"></div>
        <div id="skuList" class="sku-list"></div>
    </div>
    
    <!-- Entries Information Box -->
    <div id="entriesInfoBox" class="info-box" style="display: none;">
        <div id="entriesCount" class="entry-count"></div>
        <div id="entriesList" class="sku-list"></div>
    </div>
    
    <h3>Generated Table:</h3>
    <table id="outputTable">
        <thead>
            <tr>
                <th>productSKU</th>
                <th>type</th>
                <th>name</th>
                <th>class</th>
                <th>group</th>
                <th>owner</th>
                <th>value</th>
                <th>default</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    
    <script>
        let productSpecsData = [];
        let skuData = [];
        let storedEntries = [];
        let savedInventoryNumbers = [];
        
    const groupMapping = { 
            "Position": "Details",
"Lighting Technology": "Details",
"Lens Color": "Details",
"Housing Color": "Details",
            // Add more mappings as needed
        };
        
        document.getElementById("uploadSpecs").addEventListener("change", handleProductSpecsUpload);
        document.getElementById("uploadSKU").addEventListener("change", handleSKUUpload);
        
        function handleProductSpecsUpload(event) {
            readExcelFile(event.target.files[0], data => {
                productSpecsData = data;
                showStatus("Product Specifications File Loaded!", "success");
            });
        }
        
        function handleSKUUpload(event) {
            readExcelFile(event.target.files[0], data => {
                skuData = data;
                showStatus("SKU File Loaded!", "success");
            });
        }
        
        function readExcelFile(file, callback) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheetName = workbook.SheetNames[0];
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                callback(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById("statusMessage");
            statusDiv.textContent = message;
            statusDiv.className = "status " + type;
            statusDiv.style.display = "block";
            setTimeout(() => {
                statusDiv.style.display = "none";
            }, 3000);
        }
        
        function clearTable() {
            document.getElementById("outputTable").querySelector("tbody").innerHTML = "";
            // Also hide the SKU info box
            document.getElementById("skuInfoBox").style.display = "none";
        }
        
        function updateSKUInfo(uniqueSKUs) {
            const skuInfoBox = document.getElementById("skuInfoBox");
            const skuCount = document.getElementById("skuCount");
            const skuList = document.getElementById("skuList");
            
            if (uniqueSKUs.length === 0) {
                skuInfoBox.style.display = "none";
                return;
            }
            
            skuCount.textContent = `Found ${uniqueSKUs.length} unique SKU${uniqueSKUs.length > 1 ? 's' : ''}:`;
            
            skuList.innerHTML = "";
            uniqueSKUs.forEach(sku => {
                const skuItem = document.createElement("div");
                skuItem.textContent = sku;
                skuList.appendChild(skuItem);
            });
            
            skuInfoBox.style.display = "block";
        }
        
        function updateEntriesInfo() {
            const entriesInfoBox = document.getElementById("entriesInfoBox");
            const entriesCount = document.getElementById("entriesCount");
            const entriesList = document.getElementById("entriesList");
            
            if (savedInventoryNumbers.length === 0) {
                entriesInfoBox.style.display = "none";
                return;
            }
            
            entriesCount.textContent = `Saved Entries: ${savedInventoryNumbers.length}`;
            
            entriesList.innerHTML = "";
            savedInventoryNumbers.forEach(invNum => {
                const entryItem = document.createElement("div");
                entryItem.textContent = invNum;
                entriesList.appendChild(entryItem);
            });
            
            entriesInfoBox.style.display = "block";
        }
        
        function searchInventoryNumber() {
            const inventoryNumber = document.getElementById("searchInventory").value.trim();
            if (!inventoryNumber) {
                showStatus("Please enter an inventory number", "error");
                return;
            }
            
            if (productSpecsData.length === 0 || skuData.length === 0) {
                showStatus("Please upload both Product Specifications and SKU files first", "error");
                return;
            }
            
            // Process the inventory number but don't save it
            processInventoryNumber(inventoryNumber, false);
        }
        
        function addToEntry() {
            const inventoryNumber = document.getElementById("searchInventory").value.trim();
            if (!inventoryNumber) {
                showStatus("Please enter an inventory number to add to entries", "error");
                return;
            }
            
            if (savedInventoryNumbers.includes(inventoryNumber)) {
                showStatus("This inventory number is already saved", "error");
                return;
            }
            
            // Clear any displayed results
            clearTable();
            
            savedInventoryNumbers.push(inventoryNumber);
            showStatus(`Inventory number ${inventoryNumber} added to entries`, "success");
            
            // Update entries info
            updateEntriesInfo();
            
            // Clear the input box
            document.getElementById("searchInventory").value = "";
        }
        
        function clearEntries() {
            if (savedInventoryNumbers.length === 0) {
                showStatus("No entries to clear", "error");
                return;
            }
            
            savedInventoryNumbers = [];
            storedEntries = [];
            clearTable();
            document.getElementById("entriesInfoBox").style.display = "none";
            
            showStatus("All entries have been cleared", "success");
        }
        
        function generateFullResult() {
            if (savedInventoryNumbers.length === 0) {
                showStatus("No inventory numbers saved. Please add entries first.", "error");
                return;
            }
            
            clearTable();
            storedEntries = [];
            
            // Track all unique SKUs across all inventory numbers
            let allUniqueSKUs = [];
            
            // Process each saved inventory number and add to results
            savedInventoryNumbers.forEach(invNum => {
                const skus = processInventoryNumber(invNum, true);
                if (skus && skus.length > 0) {
                    allUniqueSKUs = [...allUniqueSKUs, ...skus];
                }
            });
            
            // Remove duplicates from allUniqueSKUs
            allUniqueSKUs = [...new Set(allUniqueSKUs)];
            
            // Update the SKU info box with all SKUs
            updateSKUInfo(allUniqueSKUs);
            
            showStatus(`Generated results for ${savedInventoryNumbers.length} inventory numbers`, "success");
        }
        
        function processInventoryNumber(inventoryNumber, addToStored) {
            // Clear the table if we're not adding to stored entries
            if (!addToStored) {
                clearTable();
                storedEntries = [];
            }
            
            let matchingSpec = null;
            for (let i = 1; i < productSpecsData.length; i++) {
                if (productSpecsData[i][0] && productSpecsData[i][0].toString() === inventoryNumber) {
                    matchingSpec = productSpecsData[i];
                    break;
                }
            }
            
            if (!matchingSpec) {
                showStatus(`Inventory Number ${inventoryNumber} not found in Product Specifications File`, "error");
                return false;
            }
            
            let className = matchingSpec[1] || "";
            let specifications = [];
            for (let i = 2; i < matchingSpec.length; i++) {
                if (matchingSpec[i] && String(matchingSpec[i]).trim() !== "") {
                    let header = productSpecsData[0][i] || "";
                    specifications.push({ name: header, value: String(matchingSpec[i] || "") });
                }
            }
            
            let matchedSKUs = [];
            for (let i = 1; i < skuData.length; i++) {
                if (skuData[i][0] && skuData[i][0].toString().includes(`-${inventoryNumber}-`)) {
                    matchedSKUs.push(skuData[i]);
                }
            }
            
            let uniqueSKUs = [...new Set(matchedSKUs.map(row => row[0]))];
            
            if (uniqueSKUs.length === 0) {
                showStatus(`No matching SKU found for inventory number ${inventoryNumber}`, "error");
                return false;
            }
            
            // Update the SKU info box if we're not in batch mode
            if (!addToStored) {
                updateSKUInfo(uniqueSKUs);
            }
            
            let tempEntries = [];
            const resultTable = document.getElementById("outputTable").querySelector("tbody");
            
            uniqueSKUs.forEach(productSKU => {
                let skuRows = matchedSKUs.filter(row => row[0] === productSKU);
                let yesEntries = [];
                let noEntries = [];
                
                skuRows.forEach(skuRow => {
                    for (let i = 1; i < skuRow.length; i += 2) {
                        let name = skuRow[i];
                        let value = skuRow[i + 1] || "";
                        if (name && value) {
                            yesEntries.push([productSKU, "T", name, className, "", "Yes", value, "Yes"]);
                        }
                    }
                });
                
                specifications.forEach(spec => {
                    let group = groupMapping[spec.name] || "";
                    noEntries.push([productSKU, "T", spec.name, className, group, "No", spec.value, "No"]);
                });
                
                [...yesEntries, ...noEntries].forEach(row => {
                    if (addToStored) {
                        storedEntries.push(row);
                    } else {
                        tempEntries.push(row);
                    }
                    resultTable.innerHTML += `<tr>${row.map(cell => `<td>${cell}</td>`).join("")}</tr>`;
                });
            });
            
            return uniqueSKUs;
        }
        
        function copyToClipboard() {
            if (storedEntries.length === 0) {
                showStatus("No data to copy. Please generate full results first.", "error");
                return;
            }
            
            // Format data for Excel (tab-separated values, no headers)
            const tsvContent = storedEntries.map(row => row.join("\t")).join("\n");
            
            // Create a temporary textarea element to copy from
            const textarea = document.createElement("textarea");
            textarea.value = tsvContent;
            textarea.style.position = "fixed";  // Make it invisible
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                // Execute copy command
                const successful = document.execCommand("copy");
                if (successful) {
                    showStatus(`Copied ${storedEntries.length} rows to clipboard`, "success");
                } else {
                    showStatus("Failed to copy data", "error");
                }
            } catch (err) {
                showStatus("Error copying data: " + err, "error");
            }
            
            // Clean up
            document.body.removeChild(textarea);
        }
    </script>
</body>
</html>